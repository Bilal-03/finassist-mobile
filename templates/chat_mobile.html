<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#2563eb">
    <title>FinAssist Mobile</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style_mobile.css') }}">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<!-- Mobile Header -->
<header class="mobile-header">
    <div class="header-brand">
        <div class="brand-icon"><i class="fas fa-chart-pie"></i></div>
        <div class="brand-text">
            <div class="brand-name">FinAssist</div>
            <div class="brand-sub">Finance Assistant</div>
        </div>
    </div>
    <div class="header-actions">
        <button class="header-btn" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </button>
    </div>
</header>

<!-- Menu Drawer -->
<div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
<div class="menu-drawer" id="menuDrawer">
    <div class="drawer-header">
        <div class="header-brand">
            <div class="brand-icon"><i class="fas fa-chart-pie"></i></div>
            <div class="brand-text">
                <div class="brand-name">FinAssist</div>
                <div class="brand-sub">Finance Assistant</div>
            </div>
        </div>
        <button class="drawer-close" onclick="closeMenu()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="drawer-menu">
        <div class="drawer-section">
            <div class="drawer-section-title">Learn</div>
            <button class="menu-item" onclick="showSection('glossary'); closeMenu();">
                <i class="fas fa-book-open"></i>
                <span>Finance Glossary</span>
            </button>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">Market</div>
            <button class="menu-item" onclick="showSection('news'); closeMenu();">
                <i class="fas fa-newspaper"></i>
                <span>Market News</span>
            </button>
            <button class="menu-item" onclick="showSection('currency'); closeMenu();">
                <i class="fas fa-exchange-alt"></i>
                <span>Currency Rates</span>
            </button>
            <button class="menu-item" onclick="showSection('metals'); closeMenu();">
                <i class="fas fa-gem"></i>
                <span>Gold & Silver</span>
            </button>
        </div>
        <div class="drawer-section">
            <div class="drawer-section-title">Tools</div>
            <button class="menu-item" onclick="showSection('emi'); closeMenu();">
                <i class="fas fa-building"></i>
                <span>EMI Calculator</span>
            </button>
            <button class="menu-item" onclick="showSection('sip'); closeMenu();">
                <i class="fas fa-coins"></i>
                <span>SIP Calculator</span>
            </button>
            <button class="menu-item" onclick="showSection('fd'); closeMenu();">
                <i class="fas fa-piggy-bank"></i>
                <span>FD Calculator</span>
            </button>
            <button class="menu-item" onclick="showSection('zakat'); closeMenu();">
                <i class="fas fa-star-and-crescent"></i>
                <span>Zakat Calculator</span>
            </button>
        </div>
    </div>
</div>

<!-- Main Container -->
<div class="mobile-container">
    <div class="content-wrapper">

        <!-- â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â• -->
        <div id="homeSection" class="section-view">

            <!-- Market Ticker Strip -->
            <div class="home-section" id="marketTickerWrap" style="overflow:hidden;">
                <div id="marketIndices">
                    <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Quick Tools -->
            <div class="home-section">
                <div class="section-title">
                    <i class="fas fa-bolt"></i> Quick Tools
                </div>
                <div class="quick-actions">
                    <div class="action-card" onclick="showSection('stock')">
                        <div class="action-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="action-title">Stock Info</div>
                    </div>
                    <div class="action-card" onclick="showSection('emi')">
                        <div class="action-icon"><i class="fas fa-building"></i></div>
                        <div class="action-title">EMI Calc</div>
                    </div>
                    <div class="action-card" onclick="showSection('sip')">
                        <div class="action-icon"><i class="fas fa-coins"></i></div>
                        <div class="action-title">SIP Calc</div>
                    </div>
                    <div class="action-card" onclick="showSection('fd')">
                        <div class="action-icon"><i class="fas fa-piggy-bank"></i></div>
                        <div class="action-title">FD Calc</div>
                    </div>
                    <div class="action-card" onclick="showSection('mf')">
                        <div class="action-icon"><i class="fas fa-layer-group"></i></div>
                        <div class="action-title">Mutual Funds</div>
                    </div>
                    <div class="action-card" onclick="showSection('zakat')">
                        <div class="action-icon"><i class="fas fa-star-and-crescent"></i></div>
                        <div class="action-title">Zakat Calc</div>
                    </div>
                </div>
            </div>

            <!-- Top Gainers -->
            <div class="home-section">
                <div class="section-title">
                    <i class="fas fa-fire"></i> Top Gainers
                </div>
                <div id="topGainersList" class="market-grid">
                    <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Top Losers -->
            <div class="home-section">
                <div class="section-title">
                    <i class="fas fa-arrow-down"></i> Top Losers
                </div>
                <div id="topLosersList" class="market-grid">
                    <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• STOCK SECTION â•â•â•â•â•â•â•â•â•â• -->
        <div id="stockSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-chart-line"></i>
                        Stock Information
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Enter Stock Name</label>
                        <input
                            type="text"
                            id="stockInput"
                            class="form-control"
                            placeholder="e.g., Reliance, TCS, HDFC"
                            onkeypress="if(event.key==='Enter') getStockInfo()"
                        >
                    </div>
                    <button class="btn btn-primary btn-block" onclick="getStockInfo()">
                        <i class="fas fa-search"></i>
                        Get Stock Price
                    </button>
                </div>
            </div>
            <div id="stockResults"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• EMI SECTION â•â•â•â•â•â•â•â•â•â• -->
        <div id="emiSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-building"></i>
                        EMI Calculator
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Loan Amount (â‚¹)</label>
                        <input type="number" id="emiAmount" class="form-control" placeholder="e.g., 500000" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (% p.a.)</label>
                        <input type="number" id="emiRate" class="form-control" placeholder="e.g., 8.5" step="0.1" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Tenure (Years)</label>
                        <input type="number" id="emiTenure" class="form-control" placeholder="e.g., 5" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="calculateEMI()">
                        <i class="fas fa-calculator"></i>
                        Calculate EMI
                    </button>
                </div>
            </div>
            <div id="emiResults"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• SIP SECTION â•â•â•â•â•â•â•â•â•â• -->
        <div id="sipSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-coins"></i>
                        SIP Calculator
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Monthly Investment (â‚¹)</label>
                        <input type="number" id="sipAmount" class="form-control" placeholder="e.g., 5000" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Expected Return (% p.a.)</label>
                        <input type="number" id="sipRate" class="form-control" placeholder="e.g., 12" step="0.1" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Investment Period (Years)</label>
                        <input type="number" id="sipTenure" class="form-control" placeholder="e.g., 10" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="calculateSIP()">
                        <i class="fas fa-calculator"></i>
                        Calculate Returns
                    </button>
                </div>
            </div>
            <div id="sipResults"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• FD SECTION â•â•â•â•â•â•â•â•â•â• -->
        <div id="fdSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-piggy-bank"></i>
                        Fixed Deposit Calculator
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Principal Amount (â‚¹)</label>
                        <input type="number" id="fdAmount" class="form-control" placeholder="e.g., 100000" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (% p.a.)</label>
                        <input type="number" id="fdRate" class="form-control" placeholder="e.g., 7" step="0.1" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Tenure (Years)</label>
                        <input type="number" id="fdTenure" class="form-control" placeholder="e.g., 2" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="calculateFD()">
                        <i class="fas fa-calculator"></i>
                        Calculate Maturity
                    </button>
                </div>
            </div>
            <div id="fdResults"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• MUTUAL FUNDS â•â•â•â•â•â•â•â•â•â• -->
        <div id="mfSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-layer-group"></i>
                        Mutual Funds
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Search Funds</label>
                        <input
                            type="text"
                            id="mfSearchInput"
                            class="form-control"
                            placeholder="Search by name..."
                            oninput="searchMutualFunds()"
                        >
                    </div>
                    <div class="form-group">
                        <label>Filter by Category</label>
                        <select id="mfCategoryFilter" class="custom-select" onchange="filterMutualFunds()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="mfResults" class="mf-list">
                <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• ZAKAT â•â•â•â•â•â•â•â•â•â• -->
        <div id="zakatSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-star-and-crescent"></i>
                        Zakat Calculator
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Cash & Bank Balance (â‚¹)</label>
                        <input type="number" id="zakatCash" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Savings / FD (â‚¹)</label>
                        <input type="number" id="zakatSavings" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Stocks Market Value (â‚¹)</label>
                        <input type="number" id="zakatStocks" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Mutual Funds (â‚¹)</label>
                        <input type="number" id="zakatMF" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Business Assets (â‚¹)</label>
                        <input type="number" id="zakatBusiness" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Gold (grams)</label>
                        <input type="number" id="zakatGold" class="form-control" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Silver (grams)</label>
                        <input type="number" id="zakatSilver" class="form-control" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="form-group">
                        <label>Debts/Liabilities (â‚¹)</label>
                        <input type="number" id="zakatDebts" class="form-control" placeholder="0" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="calculateZakat()">
                        <i class="fas fa-calculator"></i>
                        Calculate Zakat
                    </button>
                </div>
            </div>
            <div id="zakatResults"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• GLOSSARY â•â•â•â•â•â•â•â•â•â• -->
        <div id="glossarySection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-book-open"></i>
                        Finance Glossary
                    </h5>
                </div>
                <div class="widget-body">
                    <input
                        type="text"
                        id="glossarySearch"
                        class="form-control"
                        placeholder="Search terms e.g. NAV, SIP, EMI..."
                        oninput="searchGlossary()"
                    >
                </div>
            </div>
            <div id="glossaryResults" class="glossary-list"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• NEWS â•â•â•â•â•â•â•â•â•â• -->
        <div id="newsSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header" style="display:flex;align-items:center;justify-content:space-between;">
                    <h5 class="widget-title">
                        <i class="fas fa-newspaper"></i>
                        Market News
                    </h5>
                    <button class="btn btn-secondary btn-sm" onclick="loadNews()" style="padding:6px 12px;font-size:13px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div id="newsResults" class="news-list">
                <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• CURRENCY â•â•â•â•â•â•â•â•â•â• -->
        <div id="currencySection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title">
                        <i class="fas fa-exchange-alt"></i>
                        Currency Converter
                    </h5>
                </div>
                <div class="widget-body">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="currencyAmount" class="form-control" value="100" min="0" step="any" inputmode="decimal" oninput="convertCurrency()">
                    </div>
                    <div class="form-group">
                        <label>From</label>
                        <select id="currencyFrom" class="custom-select" onchange="convertCurrency()">
                            <option value="USD" selected>USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                            <option value="AED">AED - UAE Dirham</option>
                            <option value="SGD">SGD - Singapore Dollar</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="CHF">CHF - Swiss Franc</option>
                            <option value="CNY">CNY - Chinese Yuan</option>
                            <option value="INR">INR - Indian Rupee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>To</label>
                        <select id="currencyTo" class="custom-select" onchange="convertCurrency()">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                            <option value="AED">AED - UAE Dirham</option>
                            <option value="SGD">SGD - Singapore Dollar</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="CHF">CHF - Swiss Franc</option>
                            <option value="CNY">CNY - Chinese Yuan</option>
                            <option value="INR" selected>INR - Indian Rupee</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="currencyResults"></div>
            <!-- All rates table -->
            <div id="currencyRatesTable"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• METALS â•â•â•â•â•â•â•â•â•â• -->
        <div id="metalsSection" class="section-view hidden">
            <div class="widget-card">
                <div class="widget-header" style="display:flex;align-items:center;justify-content:space-between;">
                    <h5 class="widget-title">
                        <i class="fas fa-gem"></i>
                        Gold & Silver Prices
                    </h5>
                    <button class="btn btn-secondary btn-sm" onclick="loadMetals()" style="padding:6px 12px;font-size:13px;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div id="metalsResults">
                <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• TOOLS SECTION (nav shortcut) â•â•â•â•â•â•â•â•â•â• -->
        <div id="toolsSection" class="section-view hidden">
            <div class="home-section">
                <div class="section-title">
                    <i class="fas fa-calculator"></i> Calculators
                </div>
                <div class="quick-actions">
                    <div class="action-card" onclick="showSection('emi')">
                        <div class="action-icon"><i class="fas fa-building"></i></div>
                        <div class="action-title">EMI Calculator</div>
                    </div>
                    <div class="action-card" onclick="showSection('sip')">
                        <div class="action-icon"><i class="fas fa-coins"></i></div>
                        <div class="action-title">SIP Calculator</div>
                    </div>
                    <div class="action-card" onclick="showSection('fd')">
                        <div class="action-icon"><i class="fas fa-piggy-bank"></i></div>
                        <div class="action-title">FD Calculator</div>
                    </div>
                    <div class="action-card" onclick="showSection('zakat')">
                        <div class="action-icon"><i class="fas fa-star-and-crescent"></i></div>
                        <div class="action-title">Zakat Calculator</div>
                    </div>
                </div>
            </div>
            <div class="home-section">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i> Market Tools
                </div>
                <div class="quick-actions">
                    <div class="action-card" onclick="showSection('currency')">
                        <div class="action-icon"><i class="fas fa-exchange-alt"></i></div>
                        <div class="action-title">Currency</div>
                    </div>
                    <div class="action-card" onclick="showSection('metals')">
                        <div class="action-icon"><i class="fas fa-gem"></i></div>
                        <div class="action-title">Gold & Silver</div>
                    </div>
                    <div class="action-card" onclick="showSection('news')">
                        <div class="action-icon"><i class="fas fa-newspaper"></i></div>
                        <div class="action-title">Market News</div>
                    </div>
                    <div class="action-card" onclick="showSection('glossary')">
                        <div class="action-icon"><i class="fas fa-book-open"></i></div>
                        <div class="action-title">Glossary</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â• CHAT â•â•â•â•â•â•â•â•â•â• -->
        <div id="chatSection" class="section-view hidden">
            <div class="chat-container">
                <div class="messages-container" id="messagesContainer">
                    <!-- welcome message -->
                    <div class="message bot">
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">
                            ğŸ‘‹ Hi! I'm your Virtual Finance Assistant.<br><br>
                            You can ask me about:<br>
                            â€¢ Stock prices â€” <em>"price of TCS"</em><br>
                            â€¢ EMI â€” <em>"EMI for 5L at 8% for 3 years"</em><br>
                            â€¢ SIP â€” <em>"SIP 5000 monthly for 10 years at 12%"</em><br>
                            â€¢ FD â€” <em>"FD 1L at 7% for 2 years"</em>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea
                            class="chat-input"
                            id="chatInput"
                            placeholder="Ask about stocks, EMI, SIP..."
                            rows="1"
                            onkeypress="handleChatKeypress(event)"
                        ></textarea>
                        <button class="chat-send-btn" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- content-wrapper -->
</div><!-- mobile-container -->

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" onclick="showSection('home')" data-section="home">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </button>
    <button class="nav-item" onclick="showSection('stock')" data-section="stock">
        <i class="fas fa-chart-line"></i>
        <span>Stocks</span>
    </button>
    <button class="nav-item" onclick="showSection('tools')" data-section="tools">
        <i class="fas fa-calculator"></i>
        <span>Tools</span>
    </button>
    <button class="nav-item" onclick="showSection('mf')" data-section="mf">
        <i class="fas fa-layer-group"></i>
        <span>Funds</span>
    </button>
    <button class="nav-item" onclick="showSection('chat')" data-section="chat">
        <i class="fas fa-comments"></i>
        <span>Chat</span>
    </button>
</nav>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSection = 'home';
let allMutualFunds = [];
let newsLoaded    = false;
let currencyLoaded = false;
let metalsLoaded  = false;
let glossaryLoaded = false;
let mfLoaded      = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER: format Indian currency
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtINR(n) {
    if (n == null || isNaN(n)) return 'â€”';
    return Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMenu() {
    $('#menuDrawer').toggleClass('open');
    $('#menuOverlay').toggleClass('active');
}
function closeMenu() {
    $('#menuDrawer').removeClass('open');
    $('#menuOverlay').removeClass('active');
}

function showSection(section) {
    document.querySelectorAll('.section-view').forEach(el => el.classList.add('hidden'));
    const el = document.getElementById(section + 'Section');
    if (!el) return;
    el.classList.remove('hidden');
    currentSection = section;

    // Update bottom nav highlight
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === section);
    });

    // Lazy-load section data on first visit
    if (section === 'mf' && !mfLoaded)       { mfLoaded = true;       loadMutualFunds(); }
    if (section === 'glossary' && !glossaryLoaded) { glossaryLoaded = true; loadGlossary(); }
    if (section === 'news' && !newsLoaded)    { newsLoaded = true;     loadNews(); }
    if (section === 'currency' && !currencyLoaded) { currencyLoaded = true; loadCurrencyRates(); convertCurrency(); }
    if (section === 'metals' && !metalsLoaded) { metalsLoaded = true;  loadMetals(); }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME â€” Market indices & movers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadMarketIndices() {
    $.getJSON('/market_indices')
        .done(function(data) {
            if (!data || !data.length) {
                $('#marketIndices').html('<p style="color:var(--muted);font-size:13px;padding:8px 0;">Market data unavailable</p>');
                return;
            }
            let html = '<div class="market-grid">';
            data.forEach(idx => {
                const up  = idx.change >= 0;
                const cls = up ? 'positive' : 'negative';
                const ico = up ? 'â–²' : 'â–¼';
                html += `
                    <div class="market-card">
                        <div class="market-header">
                            <div class="market-name">${idx.name || idx.indexSymbol || ''}</div>
                        </div>
                        <div class="market-value">${fmtINR(idx.value ?? idx.last)}</div>
                        <div class="market-change ${cls}">
                            ${ico} ${Math.abs(idx.change || idx.variation || 0).toFixed(2)}
                            (${Math.abs(idx.change_pct || idx.percentChange || 0).toFixed(2)}%)
                        </div>
                    </div>`;
            });
            html += '</div>';
            $('#marketIndices').html(html);
        })
        .fail(function() {
            $('#marketIndices').html('<p style="color:var(--muted);font-size:13px;padding:8px 0;">Unable to load market data</p>');
        });
}

function loadTopGainers() {
    $.getJSON('/nifty_gainers')
        .done(function(data) {
            if (!data || !data.length) { $('#topGainersList').html(emptyState('No gainers data')); return; }
            let html = '';
            data.slice(0, 5).forEach(s => {
                html += `
                    <div class="market-card">
                        <div class="market-header"><div class="market-name">${s.symbol}</div></div>
                        <div class="market-value">â‚¹${fmtINR(s.lastPrice)}</div>
                        <div class="market-change positive">â–² ${Number(s.change||s.netPrice||0).toFixed(2)} (${Number(s.pChange||s.percentChange||0).toFixed(2)}%)</div>
                    </div>`;
            });
            $('#topGainersList').html(html);
        })
        .fail(function() { $('#topGainersList').html(emptyState('Unable to load gainers')); });
}

function loadTopLosers() {
    $.getJSON('/nifty_losers')
        .done(function(data) {
            if (!data || !data.length) { $('#topLosersList').html(emptyState('No losers data')); return; }
            let html = '';
            data.slice(0, 5).forEach(s => {
                html += `
                    <div class="market-card">
                        <div class="market-header"><div class="market-name">${s.symbol}</div></div>
                        <div class="market-value">â‚¹${fmtINR(s.lastPrice)}</div>
                        <div class="market-change negative">â–¼ ${Math.abs(Number(s.change||s.netPrice||0)).toFixed(2)} (${Math.abs(Number(s.pChange||s.percentChange||0)).toFixed(2)}%)</div>
                    </div>`;
            });
            $('#topLosersList').html(html);
        })
        .fail(function() { $('#topLosersList').html(emptyState('Unable to load losers')); });
}

function emptyState(msg) {
    return `<div class="empty-state"><div class="empty-text">${msg}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCK INFO  â€” uses /get_stock (POST, returns full JSON)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getStockInfo() {
    const query = $('#stockInput').val().trim();
    if (!query) { alert('Please enter a stock name'); return; }

    $('#stockResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');

    $.post('/get_stock', { symbol: query }, function(data) {
        if (data.error) {
            $('#stockResults').html(`<div class="widget-card"><div class="widget-body">${emptyState(data.error)}</div></div>`);
            return;
        }

        const up  = (data.change || 0) >= 0;
        const cls = up ? 'positive' : 'negative';
        const ico = up ? 'â–²' : 'â–¼';

        let weekHtml = '';
        if (data.week_open) {
            const wUp  = (data.week_change || 0) >= 0;
            const wCls = wUp ? 'positive' : 'negative';
            const wIco = wUp ? 'â–²' : 'â–¼';
            weekHtml = `
                <div style="margin-top:16px;">
                    <div style="font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">This Week</div>
                    <div class="stock-stats">
                        <div class="stat-item"><div class="stat-label">Week Open</div><div class="stat-value">â‚¹${fmtINR(data.week_open)}</div></div>
                        <div class="stat-item"><div class="stat-label">Week Close</div><div class="stat-value">â‚¹${fmtINR(data.week_close)}</div></div>
                        <div class="stat-item"><div class="stat-label">Week High</div><div class="stat-value" style="color:var(--green)">â‚¹${fmtINR(data.week_high)}</div></div>
                        <div class="stat-item"><div class="stat-label">Week Low</div><div class="stat-value" style="color:var(--red)">â‚¹${fmtINR(data.week_low)}</div></div>
                    </div>
                    <div style="margin-top:8px;"><span class="market-change ${wCls}">${wIco} ${Math.abs(data.week_change||0).toFixed(2)} (${Math.abs(data.week_pct||0).toFixed(2)}%)</span></div>
                </div>`;
        }

        const html = `
            <div class="stock-card">
                <div class="stock-header">
                    <div class="stock-info">
                        <div class="stock-name">${data.symbol}</div>
                        <div class="stock-symbol">NSE India</div>
                    </div>
                </div>
                <div class="stock-price">â‚¹${fmtINR(data.current)}</div>
                <span class="stock-change ${cls}">${ico} ${Math.abs(data.change||0).toFixed(2)} (${Math.abs(data.change_pct||0).toFixed(2)}%)</span>
                <div style="margin-top:16px;">
                    <div style="font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">Today</div>
                    <div class="stock-stats">
                        <div class="stat-item"><div class="stat-label">Open</div><div class="stat-value">â‚¹${fmtINR(data.open)}</div></div>
                        <div class="stat-item"><div class="stat-label">Prev Close</div><div class="stat-value">â‚¹${fmtINR(data.prev_close)}</div></div>
                        <div class="stat-item"><div class="stat-label">Day High</div><div class="stat-value" style="color:var(--green)">â‚¹${fmtINR(data.day_high)}</div></div>
                        <div class="stat-item"><div class="stat-label">Day Low</div><div class="stat-value" style="color:var(--red)">â‚¹${fmtINR(data.day_low)}</div></div>
                    </div>
                </div>
                ${weekHtml}
                <div style="margin-top:16px;display:flex;gap:8px;">
                    <button class="btn btn-secondary btn-sm" onclick="$('#stockInput').val('');$('#stockResults').html('');">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="getStockInfo()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>`;
        $('#stockResults').html(html);
    }, 'json').fail(function() {
        $('#stockResults').html(`<div class="widget-card"><div class="widget-body">${emptyState('Unable to fetch stock data')}</div></div>`);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculateEMI() {
    const principal = parseFloat($('#emiAmount').val());
    const annualRate = parseFloat($('#emiRate').val());
    const years = parseFloat($('#emiTenure').val());

    if (!principal || !annualRate || !years) { alert('Please fill all fields'); return; }

    const r = annualRate / 100 / 12;
    const n = years * 12;
    const emi = (principal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
    const total = emi * n;
    const interest = total - principal;

    // Year-by-year amortisation
    let balance = principal;
    let amort = '';
    for (let y = 1; y <= years; y++) {
        let yPrincipal = 0, yInterest = 0;
        for (let m = 0; m < 12 && balance > 0; m++) {
            const iMonth = balance * r;
            const pMonth = Math.min(emi - iMonth, balance);
            yInterest  += iMonth;
            yPrincipal += pMonth;
            balance    -= pMonth;
        }
        amort += `<tr>
            <td>Y${y}</td>
            <td style="color:var(--accent)">â‚¹${fmtINR(yPrincipal)}</td>
            <td style="color:var(--red)">â‚¹${fmtINR(yInterest)}</td>
            <td>â‚¹${fmtINR(Math.max(balance, 0))}</td>
        </tr>`;
    }

    const principalPct = ((principal / total) * 100).toFixed(1);
    const interestPct  = (100 - principalPct).toFixed(1);

    $('#emiResults').html(`
        <div class="result-card">
            <div class="result-main">
                <div class="result-label">Monthly EMI</div>
                <div class="result-value">â‚¹${fmtINR(emi)}</div>
                <div style="font-size:13px;color:var(--text-2);margin-top:4px;">for ${n} months at ${annualRate}% p.a.</div>
            </div>
            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">Loan Amount</div>
                    <div class="detail-value">â‚¹${fmtINR(principal)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Payment</div>
                    <div class="detail-value">â‚¹${fmtINR(total)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Interest</div>
                    <div class="detail-value" style="color:var(--red)">â‚¹${fmtINR(interest)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Interest %</div>
                    <div class="detail-value">${interestPct}%</div>
                </div>
            </div>
        </div>
        <div class="widget-card" style="margin-top:12px;">
            <div class="widget-header"><h5 class="widget-title">Year-by-Year Amortisation</h5></div>
            <div class="widget-body" style="padding:0;overflow-x:auto;">
                <table class="table" style="margin:0;">
                    <thead><tr><th>Year</th><th>Principal</th><th>Interest</th><th>Balance</th></tr></thead>
                    <tbody>${amort}</tbody>
                </table>
            </div>
        </div>`);
}

function calculateSIP() {
    const monthly = parseFloat($('#sipAmount').val());
    const annualRate = parseFloat($('#sipRate').val());
    const years = parseFloat($('#sipTenure').val());

    if (!monthly || !annualRate || !years) { alert('Please fill all fields'); return; }

    const r = annualRate / 100 / 12;
    const n = years * 12;
    const maturity = monthly * ((Math.pow(1 + r, n) - 1) / r) * (1 + r);
    const invested = monthly * n;
    const returns  = maturity - invested;

    // Year-by-year
    let rows = '';
    for (let y = 1; y <= years; y++) {
        const ny = y * 12;
        const val = monthly * ((Math.pow(1 + r, ny) - 1) / r) * (1 + r);
        const inv = monthly * ny;
        rows += `<tr>
            <td>Y${y}</td>
            <td style="color:var(--accent)">â‚¹${fmtINR(inv)}</td>
            <td style="color:var(--green)">â‚¹${fmtINR(val)}</td>
            <td style="color:var(--green)">â‚¹${fmtINR(val - inv)}</td>
        </tr>`;
    }

    $('#sipResults').html(`
        <div class="result-card">
            <div class="result-main">
                <div class="result-label">Maturity Amount</div>
                <div class="result-value">â‚¹${fmtINR(maturity)}</div>
            </div>
            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">Invested</div>
                    <div class="detail-value">â‚¹${fmtINR(invested)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Returns</div>
                    <div class="detail-value" style="color:var(--green)">â‚¹${fmtINR(returns)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Monthly SIP</div>
                    <div class="detail-value">â‚¹${fmtINR(monthly)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Period</div>
                    <div class="detail-value">${n} months</div>
                </div>
            </div>
        </div>
        <div class="widget-card" style="margin-top:12px;">
            <div class="widget-header"><h5 class="widget-title">Year-by-Year Growth</h5></div>
            <div class="widget-body" style="padding:0;overflow-x:auto;">
                <table class="table" style="margin:0;">
                    <thead><tr><th>Year</th><th>Invested</th><th>Value</th><th>Gain</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>`);
}

function calculateFD() {
    const principal = parseFloat($('#fdAmount').val());
    const annualRate = parseFloat($('#fdRate').val());
    const years = parseFloat($('#fdTenure').val());

    if (!principal || !annualRate || !years) { alert('Please fill all fields'); return; }

    // Quarterly compounding (standard FD)
    const n = 4; // quarters per year
    const maturity = principal * Math.pow(1 + annualRate / (100 * n), n * years);
    const interest = maturity - principal;

    $('#fdResults').html(`
        <div class="result-card">
            <div class="result-main">
                <div class="result-label">Maturity Amount</div>
                <div class="result-value">â‚¹${fmtINR(maturity)}</div>
            </div>
            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">Principal</div>
                    <div class="detail-value">â‚¹${fmtINR(principal)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Interest Earned</div>
                    <div class="detail-value" style="color:var(--green)">â‚¹${fmtINR(interest)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Rate (p.a.)</div>
                    <div class="detail-value">${annualRate}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tenure</div>
                    <div class="detail-value">${years} year${years !== 1 ? 's' : ''}</div>
                </div>
            </div>
        </div>`);
}

function calculateZakat() {
    const cash     = parseFloat($('#zakatCash').val())     || 0;
    const savings  = parseFloat($('#zakatSavings').val())  || 0;
    const stocks   = parseFloat($('#zakatStocks').val())   || 0;
    const mf       = parseFloat($('#zakatMF').val())       || 0;
    const business = parseFloat($('#zakatBusiness').val()) || 0;
    const goldG    = parseFloat($('#zakatGold').val())     || 0;
    const silverG  = parseFloat($('#zakatSilver').val())   || 0;
    const debts    = parseFloat($('#zakatDebts').val())    || 0;

    $('#zakatResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');

    $.getJSON('/metals')
        .done(function(d) {
            const goldPerGram   = d.gold   ? d.gold.price_inr / 10   : 7500;
            const silverPerGram = d.silver ? d.silver.price_inr / 1000 : 90;
            const nisab         = 85 * goldPerGram;
            const goldValue     = goldG   * goldPerGram;
            const silverValue   = silverG * silverPerGram;
            const grossWealth   = cash + savings + stocks + mf + business + goldValue + silverValue;
            const netWealth     = grossWealth - debts;
            const eligible      = netWealth >= nisab;
            const zakatDue      = eligible ? netWealth * 0.025 : 0;

            $('#zakatResults').html(`
                <div class="result-card">
                    <div class="result-main">
                        <div class="result-label">${eligible ? 'Zakat Due (2.5%)' : 'Zakat Not Applicable'}</div>
                        <div class="result-value" style="color:${eligible ? 'var(--accent)' : 'var(--muted)'}">
                            ${eligible ? 'â‚¹' + fmtINR(zakatDue) : 'â€”'}
                        </div>
                        <div style="text-align:center;margin-top:8px;font-size:13px;color:var(--text-2);">
                            ${eligible
                                ? `Net wealth â‚¹${fmtINR(netWealth)} exceeds Nisab â‚¹${fmtINR(nisab)}`
                                : `Net wealth â‚¹${fmtINR(netWealth)} is below Nisab â‚¹${fmtINR(nisab)}`}
                        </div>
                    </div>
                    <div class="result-details">
                        <div class="detail-item"><div class="detail-label">Gross Wealth</div><div class="detail-value">â‚¹${fmtINR(grossWealth)}</div></div>
                        <div class="detail-item"><div class="detail-label">Debts</div><div class="detail-value">â‚¹${fmtINR(debts)}</div></div>
                        <div class="detail-item"><div class="detail-label">Net Wealth</div><div class="detail-value">â‚¹${fmtINR(netWealth)}</div></div>
                        <div class="detail-item"><div class="detail-label">Nisab (85g Gold)</div><div class="detail-value">â‚¹${fmtINR(nisab)}</div></div>
                    </div>
                </div>`);
        })
        .fail(function() {
            $('#zakatResults').html(emptyState('Unable to fetch live gold prices'));
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MUTUAL FUNDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadMutualFunds() {
    $('#mfResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');
    $.getJSON('/mf_list', function(data) {
        allMutualFunds = data.funds || [];

        const cats = [...new Set(allMutualFunds.map(f => f.cat))].sort();
        let catHtml = '<option value="">All Categories</option>';
        cats.forEach(c => { catHtml += `<option value="${c}">${c}</option>`; });
        $('#mfCategoryFilter').html(catHtml);

        displayMutualFunds(allMutualFunds.slice(0, 50));
    }).fail(function() {
        $('#mfResults').html(emptyState('Unable to load mutual funds'));
    });
}

function displayMutualFunds(funds) {
    if (!funds.length) { $('#mfResults').html(emptyState('No funds found')); return; }
    let html = '';
    funds.forEach(f => {
        html += `
            <div class="mf-item" onclick="showMFDetail(${f.code})">
                <div class="mf-name">${f.name}</div>
                <span class="mf-category">${f.cat}</span>
            </div>`;
    });
    $('#mfResults').html(html);
}

function searchMutualFunds() {
    const q   = $('#mfSearchInput').val().toLowerCase();
    const cat = $('#mfCategoryFilter').val();
    let filtered = allMutualFunds;
    if (q)   filtered = filtered.filter(f => f.name.toLowerCase().includes(q));
    if (cat) filtered = filtered.filter(f => f.cat === cat);
    displayMutualFunds(filtered.slice(0, 50));
}
function filterMutualFunds() { searchMutualFunds(); }

function showMFDetail(code) {
    $('#mfResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');
    $.getJSON(`/mf_detail/${code}`, function(data) {
        const r1 = data.return_1y, r3 = data.return_3y, r5 = data.return_5y;

        const retBadge = (label, val) => val == null ? '' :
            `<div class="detail-item">
                <div class="detail-label">${label}</div>
                <div class="detail-value" style="color:${val>=0?'var(--green)':'var(--red)'}">
                    ${val>=0?'+':''}${val.toFixed(2)}%
                </div>
            </div>`;

        $('#mfResults').html(`
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title" style="font-size:14px;flex-wrap:wrap;">${data.schemeName}</h5>
                </div>
                <div class="widget-body">
                    <div class="stat-item" style="margin-bottom:8px;">
                        <div class="stat-label">Fund House</div>
                        <div class="stat-value" style="font-size:14px;">${data.fundHouse}</div>
                    </div>
                    <div style="background:linear-gradient(135deg,var(--accent-light),#dbeafe);border-radius:var(--radius);padding:16px;margin-bottom:12px;text-align:center;">
                        <div style="font-size:12px;color:var(--text-2);font-weight:600;">LATEST NAV (${data.navDate})</div>
                        <div style="font-size:32px;font-weight:800;color:var(--accent);font-family:'JetBrains Mono',monospace;">â‚¹${Number(data.latestNAV).toFixed(4)}</div>
                    </div>
                    <div class="result-details">
                        ${retBadge('1 Year Return', r1)}
                        ${retBadge('3 Year Return', r3)}
                        ${retBadge('5 Year Return', r5)}
                    </div>
                    <button class="btn btn-secondary btn-block" style="margin-top:16px;" onclick="loadMutualFunds();mfLoaded=false;loadMutualFunds();">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </button>
                </div>
            </div>`);
    }).fail(function() {
        $('#mfResults').html(emptyState('Unable to load fund details'));
        setTimeout(() => { mfLoaded = false; loadMutualFunds(); }, 2000);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOSSARY â€” full list matching the desktop webapp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GLOSSARY = [
    { term:"Stock / Share", cat:"Stocks", def:"A small piece of ownership in a company. When you buy a share, you become a part-owner of that company." },
    { term:"NSE", cat:"Stocks", def:"National Stock Exchange â€” India's largest stock exchange where stocks like Infosys and TCS are listed and traded." },
    { term:"BSE", cat:"Stocks", def:"Bombay Stock Exchange â€” Asia's oldest stock exchange (1875). SENSEX is its benchmark index." },
    { term:"Nifty 50", cat:"Stocks", def:"An index of the top 50 companies listed on NSE by market capitalisation. Used to measure overall market performance." },
    { term:"SENSEX", cat:"Stocks", def:"An index of the top 30 companies on BSE. 'SENS' = Sensitive, 'EX' = Index. Tracks how the market moves." },
    { term:"Bull Market", cat:"Stocks", def:"A period when stock prices are rising and investor confidence is high. 'Bull' because bulls charge upward." },
    { term:"Bear Market", cat:"Stocks", def:"A period when stock prices fall 20% or more from recent highs. 'Bear' because bears swipe downward." },
    { term:"Market Cap", cat:"Valuation", def:"Total market value of a company's outstanding shares. = Share Price Ã— Total Shares." },
    { term:"P/E Ratio", cat:"Valuation", def:"Price-to-Earnings ratio. How much investors pay per rupee of earnings. Lower can mean cheaper stock." },
    { term:"P/B Ratio", cat:"Valuation", def:"Price-to-Book ratio. Compares stock price to company's book value. Useful for banks and financial firms." },
    { term:"EPS", cat:"Valuation", def:"Earnings Per Share. Company's net profit divided by total shares. Higher EPS = more profitable." },
    { term:"Dividend", cat:"Valuation", def:"A portion of a company's profits paid to shareholders, usually quarterly or annually." },
    { term:"Dividend Yield", cat:"Valuation", def:"Annual dividend / share price. Tells how much income you earn per rupee invested." },
    { term:"SIP", cat:"Mutual Funds", def:"Systematic Investment Plan. Invest a fixed amount in a mutual fund every month, like a recurring deposit." },
    { term:"NAV", cat:"Mutual Funds", def:"Net Asset Value. The per-unit price of a mutual fund. Similar to how a stock has a share price." },
    { term:"AUM", cat:"Mutual Funds", def:"Assets Under Management. Total value of funds managed by an AMC. Larger AUM = bigger fund house." },
    { term:"ELSS", cat:"Mutual Funds", def:"Equity Linked Savings Scheme. A tax-saving mutual fund with 3-year lock-in. Offers tax benefit under 80C." },
    { term:"Index Fund", cat:"Mutual Funds", def:"A mutual fund that mimics a market index like Nifty 50 or Sensex. Low cost, passive investing." },
    { term:"AMC", cat:"Mutual Funds", def:"Asset Management Company. The company that manages your mutual fund money. E.g. HDFC AMC, SBI MF." },
    { term:"Direct Plan", cat:"Mutual Funds", def:"Buy mutual funds directly from AMC (no middleman). Lower expense ratio = better returns." },
    { term:"EMI", cat:"Loans", def:"Equated Monthly Installment. Fixed monthly payment you make to repay a loan (principal + interest)." },
    { term:"Fixed Deposit", cat:"Fixed Income", def:"A bank investment with fixed interest rate for a fixed period. Capital is guaranteed." },
    { term:"FD", cat:"Fixed Income", def:"Short for Fixed Deposit. Safe investment offering fixed returns over a specified tenure." },
    { term:"Recurring Deposit", cat:"Fixed Income", def:"Similar to FD but you deposit a fixed amount every month instead of a lump sum." },
    { term:"Coupon Rate", cat:"Fixed Income", def:"Annual interest rate paid by a bond. E.g. 7% coupon on a â‚¹1,000 bond = â‚¹70/year." },
    { term:"Inflation", cat:"General", def:"Rate at which prices of goods/services rise over time, reducing purchasing power of money." },
    { term:"Portfolio", cat:"General", def:"Collection of all your financial investments â€” stocks, FDs, mutual funds, gold, etc." },
    { term:"Diversification", cat:"General", def:"Spreading investments across different assets to reduce risk. 'Don't put all eggs in one basket.'" },
    { term:"Liquidity", cat:"General", def:"How quickly an asset can be converted to cash. Savings accounts are highly liquid; real estate is not." },
    { term:"Risk", cat:"General", def:"The chance that an investment returns less than expected. Higher risk = potentially higher reward." },
    { term:"Returns", cat:"General", def:"The profit/gain you earn on an investment, expressed as a percentage of the invested amount." },
    { term:"CAGR", cat:"General", def:"Compound Annual Growth Rate. The steady rate at which an investment would have grown each year." },
    { term:"ROI", cat:"General", def:"Return on Investment. (Gain âˆ’ Cost) / Cost Ã— 100. Measures how profitable an investment is." },
    { term:"Demat Account", cat:"General", def:"Dematerialised account that holds your stocks and mutual fund units in electronic form." },
    { term:"Broker", cat:"General", def:"An intermediary (person or app) through which you buy/sell stocks. E.g. Zerodha, Groww, Angel One." },
    { term:"SEBI", cat:"Tax & Regulation", def:"Securities and Exchange Board of India. Regulates the stock market to protect investors." },
    { term:"RBI", cat:"Tax & Regulation", def:"Reserve Bank of India. India's central bank â€” controls monetary policy and interest rates." },
    { term:"Section 80C", cat:"Tax & Regulation", def:"Income tax deduction up to â‚¹1.5 lakh for investments in ELSS, PPF, LIC, EPF, NSC, etc." },
    { term:"LTCG", cat:"Tax & Regulation", def:"Long-Term Capital Gains. Profit from selling assets held over 1 year. Taxed at 10% above â‚¹1 lakh (equity)." },
    { term:"STCG", cat:"Tax & Regulation", def:"Short-Term Capital Gains. Profit from selling equity held less than 1 year. Taxed at 15%." },
    { term:"FII / FPI", cat:"Tax & Regulation", def:"Foreign Institutional Investor / Foreign Portfolio Investor. Large overseas entities investing in Indian markets." },
    { term:"DII", cat:"Tax & Regulation", def:"Domestic Institutional Investors. Indian entities like mutual funds, insurance companies, banks." },
    { term:"IPO", cat:"Stocks", def:"Initial Public Offering. When a company sells its shares to the public for the very first time." },
    { term:"Bonus Issue", cat:"Stocks", def:"Free extra shares given to existing shareholders. E.g. 1:1 bonus means 1 free share per 1 held." },
    { term:"Stock Split", cat:"Stocks", def:"Dividing each share into multiple shares. Reduces price per share, makes it more affordable." },
    { term:"Volatility", cat:"General", def:"How much a stock's price fluctuates. High volatility = bigger swings, more risk and opportunity." },
    { term:"Blue Chip", cat:"Stocks", def:"Shares of large, well-established, financially sound companies with a long track record." },
    { term:"Penny Stock", cat:"Stocks", def:"Very low-priced stocks, usually of small companies. High risk, highly speculative." },
    { term:"Circuit Breaker", cat:"Stocks", def:"Automatic halt in trading when a stock moves beyond a set limit (e.g. 5%, 10%, 20%) in a day." },
    { term:"Zakat", cat:"General", def:"Islamic obligatory charity â€” 2.5% of net wealth above the Nisab threshold, paid annually." },
    { term:"Nisab", cat:"General", def:"Minimum wealth threshold for Zakat eligibility. Currently equivalent to the value of 85g of gold." },
];

function loadGlossary() {
    displayGlossary(GLOSSARY);
}

function displayGlossary(terms) {
    let html = '';
    terms.forEach(t => {
        html += `
            <div class="glossary-item">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <div class="glossary-term">${t.term}</div>
                    <span style="font-size:11px;padding:2px 8px;background:var(--accent-light);color:var(--accent);border-radius:20px;font-weight:600;">${t.cat}</span>
                </div>
                <div class="glossary-definition">${t.def}</div>
            </div>`;
    });
    $('#glossaryResults').html(html || emptyState('No terms found'));
}

function searchGlossary() {
    const q = $('#glossarySearch').val().toLowerCase();
    if (!q) { displayGlossary(GLOSSARY); return; }
    displayGlossary(GLOSSARY.filter(t =>
        t.term.toLowerCase().includes(q) || t.def.toLowerCase().includes(q) || t.cat.toLowerCase().includes(q)
    ));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEWS â€” uses /news endpoint (returns array with .title/.source/.link/.published)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadNews() {
    $('#newsResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');
    $.getJSON('/news', function(data) {
        if (!data || !data.length) { $('#newsResults').html(emptyState('No news available')); return; }
        let html = '';
        data.slice(0, 30).forEach(article => {
            const link    = article.link || article.url || '#';
            const source  = article.source || '';
            const pubStr  = article.published || article.publishedAt || '';

            // Try to parse the RFC-2822 date that the backend sends
            let timeDisplay = '';
            if (pubStr) {
                const d = new Date(pubStr);
                if (!isNaN(d.getTime())) {
                    const diff = Math.round((Date.now() - d.getTime()) / 60000);
                    if (diff < 60)        timeDisplay = `${diff}m ago`;
                    else if (diff < 1440) timeDisplay = `${Math.round(diff/60)}h ago`;
                    else                  timeDisplay = `${Math.round(diff/1440)}d ago`;
                }
            }

            const sourceColor = article.color || 'var(--accent)';
            html += `
                <div class="news-card" onclick="window.open('${link}', '_blank')">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
                        <span style="font-size:11px;font-weight:700;color:white;background:${sourceColor};padding:2px 8px;border-radius:20px;">${source}</span>
                        ${timeDisplay ? `<span style="font-size:12px;color:var(--muted);"><i class="fas fa-clock"></i> ${timeDisplay}</span>` : ''}
                    </div>
                    <div class="news-title">${article.title}</div>
                    <div style="font-size:12px;color:var(--accent);margin-top:6px;font-weight:600;">Read more â†’</div>
                </div>`;
        });
        $('#newsResults').html(html);
    }).fail(function() {
        $('#newsResults').html(emptyState('Unable to load news'));
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CURRENCY â€” uses /currency_convert for conversion + /currency for rates table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _currencyDebounce = null;

function convertCurrency() {
    clearTimeout(_currencyDebounce);
    _currencyDebounce = setTimeout(_doConvert, 400);
}

function _doConvert() {
    const amount = parseFloat($('#currencyAmount').val()) || 1;
    const from   = $('#currencyFrom').val();
    const to     = $('#currencyTo').val();

    $('#currencyResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');

    $.getJSON(`/currency_convert?from=${from}&to=${to}&amount=${amount}`, function(data) {
        if (data.error) { $('#currencyResults').html(emptyState('Conversion error: ' + data.error)); return; }
        $('#currencyResults').html(`
            <div class="result-card">
                <div class="result-main">
                    <div class="result-label">${amount} ${from} =</div>
                    <div class="result-value">${Number(data.converted).toFixed(4)} ${to}</div>
                    <div style="text-align:center;margin-top:8px;font-size:13px;color:var(--text-2);">
                        Rate: 1 ${from} = ${Number(data.rate).toFixed(4)} ${to}
                        <br><span style="color:var(--muted);font-size:11px;">Source: ECB via Frankfurter Â· ${data.date}</span>
                    </div>
                </div>
            </div>`);
    }).fail(function() {
        $('#currencyResults').html(emptyState('Unable to fetch exchange rates'));
    });
}

function loadCurrencyRates() {
    $('#currencyRatesTable').html('<div class="loading-spinner"><div class="spinner"></div></div>');
    $.getJSON('/currency', function(data) {
        if (data.error) { $('#currencyRatesTable').html(''); return; }
        let rows = '';
        (data.rates || []).forEach(r => {
            rows += `<tr>
                <td>${r.flag} <strong>${r.code}</strong></td>
                <td>${r.name}</td>
                <td style="text-align:right;font-weight:700;color:var(--accent);">â‚¹${Number(r.inr_per_unit).toFixed(2)}</td>
                <td style="text-align:right;color:var(--muted);font-size:13px;">${Number(r.unit_per_inr).toFixed(6)}</td>
            </tr>`;
        });
        $('#currencyRatesTable').html(`
            <div class="widget-card">
                <div class="widget-header">
                    <h5 class="widget-title"><i class="fas fa-table"></i> All Rates vs â‚¹ INR</h5>
                </div>
                <div class="widget-body" style="padding:0;overflow-x:auto;">
                    <table class="table" style="margin:0;">
                        <thead><tr><th>Code</th><th>Currency</th><th style="text-align:right;">1 Unit â†’ â‚¹</th><th style="text-align:right;">â‚¹1 â†’</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div style="padding:8px 16px;font-size:11px;color:var(--muted);">Source: ${data.source} Â· ${data.date}</div>
            </div>`);
    }).fail(function() { $('#currencyRatesTable').html(''); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// METALS â€” uses /metals endpoint
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadMetals() {
    $('#metalsResults').html('<div class="loading-spinner"><div class="spinner"></div></div>');
    $.getJSON('/metals', function(d) {
        if (d.error) { $('#metalsResults').html(emptyState(d.error)); return; }

        const metalCard = (name, icon, color, price, unit, intlUSD, intlUnit, change, changePct, prevPrice) => {
            const up  = change >= 0;
            const cls = up ? 'positive' : 'negative';
            const ico = up ? 'â–²' : 'â–¼';
            return `
                <div class="widget-card" style="margin-bottom:12px;">
                    <div class="widget-body">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                            <div style="width:44px;height:44px;background:${color};border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;">${icon}</div>
                            <div>
                                <div style="font-size:18px;font-weight:700;">${name}</div>
                                <div style="font-size:12px;color:var(--muted);">${unit}</div>
                            </div>
                            <div style="margin-left:auto;text-align:right;">
                                <div style="font-size:12px;color:var(--muted);">International</div>
                                <div style="font-size:13px;font-weight:600;color:var(--text-2);">$${Number(intlUSD).toFixed(2)}/${intlUnit}</div>
                            </div>
                        </div>
                        <div style="font-size:30px;font-weight:800;color:var(--text);font-family:'JetBrains Mono',monospace;">â‚¹${fmtINR(price)}</div>
                        <div style="margin-top:8px;display:flex;align-items:center;gap:12px;">
                            <span class="market-change ${cls}">${ico} â‚¹${fmtINR(Math.abs(change))} (${Math.abs(changePct).toFixed(2)}%)</span>
                        </div>
                        <div style="margin-top:8px;font-size:12px;color:var(--muted);">Prev Close: â‚¹${fmtINR(prevPrice)}</div>
                    </div>
                </div>`;
        };

        let html = '';
        if (d.gold)   html += metalCard('Gold',   'ğŸ¥‡', 'rgba(217,119,6,0.15)',  d.gold.price_inr,   'per 10g Â· MCX Futures', d.gold.price_usd_oz,   'oz', d.gold.change,   d.gold.change_pct,   d.gold.prev_inr);
        if (d.silver) html += metalCard('Silver', 'ğŸ¥ˆ', 'rgba(148,163,184,0.2)', d.silver.price_inr, 'per kg Â· MCX Futures',  d.silver.price_usd_oz, 'oz', d.silver.change, d.silver.change_pct, d.silver.prev_inr);

        if (d.usd_inr) {
            html += `<div style="font-size:12px;color:var(--muted);text-align:center;padding:4px;">USD/INR Rate Used: â‚¹${d.usd_inr} Â· Source: ${d.source}</div>`;
        }
        $('#metalsResults').html(html);
    }).fail(function() {
        $('#metalsResults').html(emptyState('Unable to load metal prices'));
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT  â€” posts to /chat (alias of /get on the backend)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleChatKeypress(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
}

function sendChatMessage() {
    const input   = $('#chatInput');
    const message = input.val().trim();
    if (!message) return;

    addChatMessage(message, 'user');
    input.val('').css('height', 'auto');

    const loadId = 'loading_' + Date.now();
    $('#messagesContainer').append(`<div id="${loadId}" class="message bot">
        <div class="message-avatar"><i class="fas fa-robot"></i></div>
        <div class="message-content"><div class="loading-spinner" style="padding:4px;"><div class="spinner" style="width:24px;height:24px;border-width:2px;"></div></div></div>
    </div>`);
    scrollChat();

    $.post('/chat', { msg: message }, function(response) {
        $(`#${loadId}`).remove();
        addChatMessage(response, 'bot');
    }).fail(function() {
        $(`#${loadId}`).remove();
        addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
    });
}

function addChatMessage(content, type) {
    const avatar = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
    $('#messagesContainer').append(`
        <div class="message ${type}">
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${content}</div>
        </div>`);
    scrollChat();
}

function scrollChat() {
    const c = document.getElementById('messagesContainer');
    if (c) c.scrollTop = c.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(document).ready(function () {
    loadMarketIndices();
    loadTopGainers();
    loadTopLosers();

    // Auto-resize chat textarea
    $('#chatInput').on('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Refresh home data every 5 minutes
    setInterval(function () {
        if (currentSection === 'home') {
            loadMarketIndices();
            loadTopGainers();
            loadTopLosers();
        }
    }, 300000);
});
</script>
</body>
</html>
